name: ROS2 CI (Humble) - colcon build (no tests)

on:
  pull_request:
  push:
    branches: [ main ]

jobs:
  build_and_test:
    runs-on: ubuntu-22.04

    container:
      image: ghcr.io/ros-tooling/setup-ros-docker/setup-ros-docker-ubuntu-jammy:latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # Fix missing directories
      - name: Fix package directory structure
        run: |
          # Find and fix ros2_learning_pkg
          PKG_PATH=$(find . -type d -path "*/src/*/ros2_learning_pkg" | head -1 || true)
          if [ -n "$PKG_PATH" ]; then
            mkdir -p "$PKG_PATH/include/ros2_learning_pkg"
            touch "$PKG_PATH/include/ros2_learning_pkg/.gitkeep"
          fi
          
          # Fix cpp_oops_package
          CPP_PKG_PATH=$(find . -type d -path "*/src/*/cpp_oops_package" | head -1 || true)
          if [ -n "$CPP_PKG_PATH" ]; then
            mkdir -p "$CPP_PKG_PATH/launch"
            echo "# Launch files" > "$CPP_PKG_PATH/launch/README.md"
          fi

      # Build only - skip tests completely
      - name: Build (action-ros-ci)
        uses: ros-tooling/action-ros-ci@0.4.5
        with:
          target-ros2-distro: humble
          skip-tests: true  # Skip all tests
          
      # Upload logs
      - name: Upload colcon logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: colcon-logs
          path: ${{ steps.ros_ci.outputs.ros-workspace-directory-name }}/log
